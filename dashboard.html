<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • SkyFrost</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="assets/ui.css">
</head>
<body>
  <div class="topbar">
    <div class="inner">
      <a class="brand" href="index.html">
        <div class="brand-badge">
          <img id="brandLogo" alt="SkyFrost" src="assets/logo.png">
          <div class="fallback" id="brandFallback">SF</div>
        </div>
        <div>SkyFrost</div>
      </a>
      <nav class="nav">
        <a class="active" href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a href="profilo.html"><i class="bi bi-bag-fill"></i> Store</a>
        <a href="staff.html"><i class="bi bi-people-fill"></i> Staff</a>
        <a href="vote.html"><i class="bi bi-hand-thumbs-up-fill"></i> Vote</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <h1>Dashboard</h1>
    <p class="sub">Panoramica rapida del tuo account e accesso veloce alle sezioni principali.</p>

    <div class="grid two">
      <div class="panel">
        <div class="pad">
          <div class="row">
            <div>
              <div class="badge good" id="statusBadge"><i class="bi bi-arrow-repeat"></i> Caricamento…</div>
              <div style="margin-top:10px; font-weight:900; font-size:18px" id="hello">Ciao!</div>
              <div class="small" id="helloSub">Controllo sessione e ruoli Discord…</div>
            </div>
            <div class="spacer"></div>
            <a class="btn primary" href="profilo.html"><i class="bi bi-bag-fill"></i> Vai allo Store</a>
          </div>

          <div class="line"></div>

          <div class="cards" style="grid-template-columns: repeat(4, minmax(0, 1fr));">
            <a class="card" href="staff.html" style="text-decoration:none">
              <div class="body">
                <div class="title"><i class="bi bi-people-fill"></i> Staff</div>
                <div class="muted">Vedi ruoli e membri staff.</div>
              </div>
            </a>
            <a class="card" href="vote.html" style="text-decoration:none">
              <div class="body">
                <div class="title"><i class="bi bi-hand-thumbs-up-fill"></i> Vote</div>
                <div class="muted">Supporta il server con un voto.</div>
              </div>
            </a>
            <a class="card" href="wiki.html" style="text-decoration:none">
              <div class="body">
                <div class="title"><i class="bi bi-journal-bookmark-fill"></i> Wiki</div>
                <div class="muted">Guide e informazioni utili.</div>
              </div>
            </a>
            <a class="card" href="supporto.html" style="text-decoration:none">
              <div class="body">
                <div class="title"><i class="bi bi-life-preserver"></i> Supporto</div>
                <div class="muted">Apri ticket o contattaci.</div>
              </div>
            </a>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="pad">
          <div class="row">
            <div style="font-weight:900"><i class="bi bi-person-badge-fill"></i> Account</div>
            <div class="spacer"></div>
            <a class="btn" id="loginBtn" href="/api/login" style="display:none"><i class="bi bi-discord"></i> Login Discord</a>
            <button class="btn danger" id="logoutBtn" style="display:none"><i class="bi bi-box-arrow-right"></i> Logout</button>
          </div>

          <div class="line"></div>

          <div id="accountBox">
            <div class="skeleton"></div>
          </div>

          <div class="line"></div>

          <div style="font-weight:900; margin-bottom:8px"><i class="bi bi-tags-fill"></i> Ruoli</div>
          <div id="rolesBox"><div class="skeleton" style="height:80px"></div></div>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/ui.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function setStatus(ok, text){
      const b = $("statusBadge");
      b.className = ok ? "badge good" : "badge";
      b.innerHTML = ok
        ? `<i class="bi bi-check2-circle"></i> ${esc(text)}`
        : `<i class="bi bi-exclamation-circle"></i> ${esc(text)}`;
    }

    async function loadRoles(){
      // endpoint principale già nel tuo progetto: /api/roles
      const r = await fetch("/api/roles", { credentials: "include", cache: "no-store" });
      if (!r.ok){
        // 401/403: non loggato o non autorizzato
        return { ok:false, status:r.status, text: await r.text().catch(()=> "") };
      }
      const j = await r.json();
      return { ok:true, data:j };
    }

    function renderAccount(user){
      const name = user?.global_name || user?.username || "utente";
      const discr = user?.discriminator && user.discriminator !== "0" ? ("#" + user.discriminator) : "";
      const avatar = user?.avatar_url || user?.avatar || null;

      $("hello").textContent = `Ciao, ${name}${discr}`;
      $("helloSub").textContent = "Sessione attiva. Qui sotto trovi i tuoi ruoli visibili nel server.";

      $("accountBox").innerHTML = `
        <div class="item">
          <div class="brand-badge" style="width:44px; height:44px; border-radius:14px; background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10)">
            ${avatar ? `<img alt="" src="${esc(avatar)}">` : `<div class="fallback" style="display:grid">U</div>`}
          </div>
          <div>
            <div style="font-weight:900">${esc(name)}${esc(discr)}</div>
            <div class="small">${esc(user?.id || "")}</div>
          </div>
          <div class="right">
            <div class="badge"><i class="bi bi-shield-check"></i> Discord</div>
          </div>
        </div>
      `;
    }

    function renderRoles(roles){
      if (!Array.isArray(roles) || roles.length === 0){
        $("rolesBox").innerHTML = `<div class="empty">Nessun ruolo disponibile.</div>`;
        return;
      }
      // supporta sia stringhe che oggetti {name,color}
      const chips = roles.map(r => {
        const name = (typeof r === "string") ? r : (r?.name ?? "");
        return `<span class="chip">${esc(name)}</span>`;
      }).join("");
      $("rolesBox").innerHTML = `<div class="chips">${chips}</div>`;
    }

    async function init(){
      try{
        setStatus(false, "Caricamento…");
        const res = await loadRoles();

        if (!res.ok){
          setStatus(false, res.status === 401 ? "Non loggato" : "Accesso negato / errore API");
          $("accountBox").innerHTML = `<div class="empty">Per vedere i ruoli devi fare login con Discord.</div>`;
          $("rolesBox").innerHTML = `<div class="empty">—</div>`;
          $("loginBtn").style.display = "inline-flex";
          return;
        }

        // best-effort parsing (non rompiamo se la forma cambia)
        const data = res.data || {};
        const user = data.user || data.me || data.discord_user || data.account || null;
        const roles = data.roles || data.allowedRoles || data.user_roles || data.memberRoles || [];

        setStatus(true, "Pronto");
        $("logoutBtn").style.display = "inline-flex";
        renderAccount(user);
        renderRoles(roles);
      }catch(e){
        console.error(e);
        setStatus(false, "Errore");
        $("accountBox").innerHTML = `<div class="empty">Errore nel caricamento.</div>`;
        $("rolesBox").innerHTML = `<div class="empty">—</div>`;
        $("loginBtn").style.display = "inline-flex";
      }
    }

    $("logoutBtn").addEventListener("click", async () => {
      try{
        await fetch("/api/logout", { method:"POST", credentials:"include" });
      }catch(e){}
      location.reload();
    });

    init();
  </script>
</body>
</html>
