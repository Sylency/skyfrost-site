<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • SkyFrost</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="assets/ui.css">
</head>
<body>
  <div class="topbar">
    <div class="inner">
      <a class="brand" href="index.html">
        <div class="brand-badge">
          <img id="brandLogo" alt="SkyFrost" src="assets/logo.png">
          <div class="fallback" id="brandFallback">SF</div>
        </div>
        <div>SkyFrost</div>
      </a>
      <nav class="nav">
        <a class="active" href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a href="profilo.html"><i class="bi bi-bag-fill"></i> Store</a>
        <a href="staff.html"><i class="bi bi-people-fill"></i> Staff</a>
        <a href="vote.html"><i class="bi bi-hand-thumbs-up-fill"></i> Vote</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <h1>Dashboard</h1>
    <p class="sub">Panoramica rapida e accesso veloce alle sezioni principali.</p>

    <div class="grid two">
      <div class="panel">
        <div class="pad">
          <div class="row">
            <div>
              <div class="badge good" id="statusBadge"><i class="bi bi-arrow-repeat"></i> Caricamento…</div>
              <div style="margin-top:10px; font-weight:900; font-size:18px" id="hello">Ciao!</div>
              <div class="small" id="helloSub">Controllo sessione e ruoli…</div>
            </div>
            <div class="spacer"></div>
            <a class="btn primary" href="profilo.html"><i class="bi bi-bag-fill"></i> Vai allo Store</a>
          </div>

          <div class="line"></div>

          <div class="cards" style="grid-template-columns: repeat(4, minmax(0, 1fr));">
            <a class="card" href="staff.html" style="text-decoration:none">
              <div class="body">
                <div class="title"><i class="bi bi-people-fill"></i> Staff</div>
                <div class="muted">Vedi ruoli e membri staff.</div>
              </div>
            </a>
            <a class="card" href="vote.html" style="text-decoration:none">
              <div class="body">
                <div class="title"><i class="bi bi-hand-thumbs-up-fill"></i> Vote</div>
                <div class="muted">Supporta il server con un voto.</div>
              </div>
            </a>
            <a class="card" href="wiki.html" style="text-decoration:none">
              <div class="body">
                <div class="title"><i class="bi bi-journal-bookmark-fill"></i> Wiki</div>
                <div class="muted">Guide e informazioni utili.</div>
              </div>
            </a>
            <a class="card" href="supporto.html" style="text-decoration:none">
              <div class="body">
                <div class="title"><i class="bi bi-life-preserver"></i> Supporto</div>
                <div class="muted">Apri ticket o contattaci.</div>
              </div>
            </a>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="pad">
          <div class="row">
            <div style="font-weight:900"><i class="bi bi-person-badge-fill"></i> Sessione</div>
            <div class="spacer"></div>
            <a class="btn" id="loginBtn" href="/api/login" style="display:none"><i class="bi bi-discord"></i> Login Discord</a>
            <a class="btn danger" id="logoutBtn" href="/api/logout" style="display:none"><i class="bi bi-box-arrow-right"></i> Logout</a>
          </div>

          <div class="line"></div>

          <div id="accountBox">
            <div class="skeleton"></div>
          </div>

          <div class="line"></div>

          <div style="font-weight:900; margin-bottom:8px"><i class="bi bi-tags-fill"></i> Ruoli</div>
          <div id="rolesBox"><div class="skeleton" style="height:80px"></div></div>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/ui.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function setStatus(ok, text){
      const b = $("statusBadge");
      b.className = ok ? "badge good" : "badge";
      b.innerHTML = ok
        ? `<i class="bi bi-check2-circle"></i> ${esc(text)}`
        : `<i class="bi bi-exclamation-circle"></i> ${esc(text)}`;
    }

    function renderLoggedOut(reason){
      setStatus(false, reason === "not_in_guild" ? "Non nel server" : "Non loggato");
      $("hello").textContent = "Ciao!";
      $("helloSub").textContent = "Fai login con Discord per vedere ruoli e badge.";
      $("accountBox").innerHTML = `<div class="empty">Non sei loggato. Premi “Login Discord”.</div>`;
      $("rolesBox").innerHTML = `<div class="empty">—</div>`;
      $("loginBtn").style.display = "inline-flex";
      $("logoutBtn").style.display = "none";
    }

    function renderRoles(payload){
      const roles = Array.isArray(payload?.roles) ? payload.roles : [];
      const primary = payload?.primaryRole?.name || null;

      $("hello").textContent = primary ? `Ruolo principale: ${primary}` : "Ruolo principale: —";
      $("helloSub").textContent = payload?.booster ? "Nitro Booster attivo ✅" : "—";

      $("accountBox").innerHTML = `
        <div class="item">
          <div>
            <div style="font-weight:900">Sessione Discord</div>
            <div class="small">Ruoli mostrati: ${roles.length}</div>
          </div>
          <div class="right">
            ${primary ? `<span class="badge good"><i class="bi bi-award-fill"></i> ${esc(primary)}</span>` : `<span class="badge"><i class="bi bi-person"></i> Utente</span>`}
          </div>
        </div>
      `;

      if (!roles.length){
        $("rolesBox").innerHTML = `<div class="empty">Nessun ruolo allowlist trovato.</div>`;
        return;
      }
      $("rolesBox").innerHTML = `<div class="chips">${roles.map(r => `<span class="chip">${esc(r.name)}</span>`).join("")}</div>`;
    }

    async function init(){
      try{
        setStatus(false, "Caricamento…");
        const r = await fetch("/api/roles", { credentials:"include", cache:"no-store" });
        if (!r.ok){
          // questo endpoint di solito risponde 200, ma gestiamo comunque
          throw new Error(`${r.status} ${r.statusText}`);
        }
        const j = await r.json();

        if (!j?.ok){
          renderLoggedOut(j?.reason || "not_logged_in");
          return;
        }

        setStatus(true, "Pronto");
        $("loginBtn").style.display = "none";
        $("logoutBtn").style.display = "inline-flex";
        renderRoles(j);
      }catch(e){
        console.error(e);
        setStatus(false, "Errore API");
        $("accountBox").innerHTML = `<div class="errbox show">Errore nel caricamento. (${esc(e.message)})</div>`;
        $("rolesBox").innerHTML = `<div class="empty">—</div>`;
        $("loginBtn").style.display = "inline-flex";
        $("logoutBtn").style.display = "none";
      }
    }

    init();
  </script>
</body>
</html>
