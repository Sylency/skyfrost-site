<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff • SkyFrost</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="assets/ui.css">
</head>
<body>
  <div class="topbar">
    <div class="inner">
      <a class="brand" href="index.html">
        <div class="brand-badge">
          <img id="brandLogo" alt="SkyFrost" src="assets/logo.png">
          <div class="fallback" id="brandFallback">SF</div>
        </div>
        <div>SkyFrost</div>
      </a>
      <nav class="nav">
        <a href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a href="profilo.html"><i class="bi bi-bag-fill"></i> Store</a>
        <a class="active" href="staff.html"><i class="bi bi-people-fill"></i> Staff</a>
        <a href="vote.html"><i class="bi bi-hand-thumbs-up-fill"></i> Vote</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <h1>Staff</h1>
    <p class="sub">Lista staff raggruppata per ruolo. Cerca un membro e filtra le sezioni.</p>

    <div class="panel">
      <div class="pad">
        <div class="row">
          <div class="search">
            <i class="bi bi-search"></i>
            <input id="q" placeholder="Cerca per nome…" autocomplete="off" />
          </div>
          <button class="btn" id="toggleEmpty"><i class="bi bi-eye-slash"></i> Nascondi vuoti</button>
          <button class="btn" id="expandAll"><i class="bi bi-arrows-expand"></i> Espandi</button>
          <button class="btn primary" id="refresh"><i class="bi bi-arrow-clockwise"></i> Aggiorna</button>
        </div>
        <div class="line"></div>
        <div id="status" class="small">Caricamento…</div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div id="list"></div>
  </div>

  <script src="assets/ui.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    let raw = null;
    let hideEmpty = false;
    let expanded = true;

    function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function normalize(data){
      if (!data) return [];
      // forma reale del tuo endpoint: { ok:true, sections:[...] }
      if (Array.isArray(data.sections)) return data.sections;
      if (Array.isArray(data.groups)) return data.groups;
      if (Array.isArray(data.staff)) return data.staff;
      if (Array.isArray(data.data)) return data.data;
      if (Array.isArray(data)) return data;
      return [];
    }

    function memberRow(m){
      const name = m?.display || m?.display_name || m?.nick || m?.username || "Membro";
      const handle = m?.username || "";
      const avatar = m?.avatar || m?.avatar_url || null;
      return `
        <div class="item">
          <div class="brand-badge" style="width:36px; height:36px; border-radius:14px; background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10)">
            ${avatar ? `<img alt="" src="${esc(avatar)}">` : `<div class="fallback" style="display:grid">U</div>`}
          </div>
          <div>
            <div style="font-weight:900">${esc(name)}</div>
            <div class="small">${esc(handle)}</div>
          </div>
        </div>
      `;
    }

    function render(){
      const q = $("q").value.trim().toLowerCase();
      const groups = normalize(raw);
      const out = [];

      for (const g of groups){
        const roleName = g?.role?.name || g?.role || g?.name || "Ruolo";
        const members = Array.isArray(g?.members) ? g.members : (Array.isArray(g?.users) ? g.users : []);

        const filtered = members.filter(m => {
          if (!q) return true;
          const s = `${m?.display||""} ${m?.display_name||""} ${m?.nick||""} ${m?.username||""}`.toLowerCase();
          return s.includes(q);
        });

        if (hideEmpty && filtered.length === 0) continue;

        out.push(`
          <details ${expanded ? "open" : ""}>
            <summary>
              <i class="bi bi-person-lines-fill" style="color:rgba(125,211,252,.9)"></i>
              ${esc(roleName)}
              <span class="badge" style="margin-left:auto"><i class="bi bi-people"></i> ${filtered.length}</span>
            </summary>
            <div class="details-body">
              ${filtered.length ? `<div class="list">${filtered.map(memberRow).join("")}</div>` : `<div class="empty">Nessun membro in questa sezione.</div>`}
            </div>
          </details>
        `);
      }

      $("list").innerHTML = out.length
        ? out.join('<div style="height:12px"></div>')
        : `<div class="panel"><div class="pad"><div class="empty">Nessun risultato.</div></div></div>`;
    }

    async function load(){
      $("status").textContent = "Caricamento…";
      $("list").innerHTML = `
        <div class="panel"><div class="pad"><div class="skeleton"></div></div></div>
        <div style="height:10px"></div>
        <div class="panel"><div class="pad"><div class="skeleton"></div></div></div>
      `;
      try{
        const r = await fetch("/api/staff", { cache:"no-store" });
        if (!r.ok){
          const t = await r.text().catch(()=> "");
          throw new Error(`${r.status} ${r.statusText} ${t ? "— " + t.slice(0,140) : ""}`);
        }
        raw = await r.json();
        const groups = normalize(raw);
        const fetched = raw?.fetched_members ?? null;
        $("status").textContent = fetched != null
          ? `Caricato: ${groups.length} sezioni • membri letti: ${fetched}`
          : `Caricato: ${groups.length} sezioni.`;
        render();
      }catch(e){
        console.error(e);
        $("status").textContent = "Errore nel caricamento staff.";
        $("list").innerHTML = `<div class="panel"><div class="pad"><div class="errbox show">Non riesco a caricare lo staff. (${esc(e.message)})</div></div></div>`;
      }
    }

    $("q").addEventListener("input", render);
    $("toggleEmpty").addEventListener("click", () => {
      hideEmpty = !hideEmpty;
      $("toggleEmpty").innerHTML = hideEmpty ? `<i class="bi bi-eye"></i> Mostra vuoti` : `<i class="bi bi-eye-slash"></i> Nascondi vuoti`;
      render();
    });
    $("expandAll").addEventListener("click", () => {
      expanded = !expanded;
      $("expandAll").innerHTML = expanded ? `<i class="bi bi-arrows-collapse"></i> Comprimi` : `<i class="bi bi-arrows-expand"></i> Espandi`;
      render();
    });
    $("refresh").addEventListener("click", load);

    load();
  </script>
</body>
</html>
